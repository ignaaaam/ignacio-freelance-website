---
// Real Website Examples Carousel Component
interface Props {
  lang?: "es" | "en";
}

const { lang = "es" } = Astro.props;

// Cache busting version for videos
const CACHE_VERSION = "v20250816-2";

// Real website examples with actual assets
const websiteExamples = [
  {
    id: 1,
    title: lang === "es" ? "Plataforma SaaS con IA" : "AI SaaS Platform",
    category: lang === "es" ? "SaaS / Inteligencia Artificial" : "SaaS / AI",
    description: lang === "es" ? "Dashboard moderno con integraci√≥n de IA" : "Modern dashboard with AI integration",
    asset: "/images/hero-websites/ai-landing-website.webp",
    type: "image",
    bgGradient: "from-blue-600 to-purple-700",
    icon: "ü§ñ"
  },
  {
    id: 2,
    title: lang === "es" ? "Aplicaci√≥n Fintech Credify" : "Credify Fintech App",
    category: lang === "es" ? "Fintech / Servicios Financieros" : "Fintech / Financial Services",
    description: lang === "es" ? "Plataforma de cr√©dito con animaciones premium" : "Credit platform with premium animations",
    asset: "/images/hero-websites/credify-landing-website.webm",
    type: "video",
    bgGradient: "from-green-600 to-emerald-700",
    icon: "üí≥"
  },
  {
    id: 3,
    title: lang === "es" ? "Gesti√≥n de Redes Sociales" : "Social Media Management",
    category: lang === "es" ? "Marketing Digital / SaaS" : "Digital Marketing / SaaS",
    description: lang === "es" ? "Herramienta completa para gestionar redes sociales" : "Complete tool for social media management",
    asset: "/images/hero-websites/social-media-manager-website-video-compressed.webm",
    type: "video",
    bgGradient: "from-pink-600 to-rose-700",
    icon: "üì±"
  },
  {
    id: 4,
    title: lang === "es" ? "Agencia de Marketing" : "Marketing Agency",
    category: lang === "es" ? "Agencia / Servicios Creativos" : "Agency / Creative Services",
    description: lang === "es" ? "Landing page de alto impacto para agencia digital" : "High-impact landing page for digital agency",
    asset: "/images/hero-websites/marketing-agency-video-website-compressed.webm",
    type: "video",
    bgGradient: "from-orange-600 to-red-700",
    icon: "üéØ"
  },
  {
    id: 5,
    title: lang === "es" ? "Soluci√≥n Fintech Innovadora" : "Innovative Fintech Solution",
    category: lang === "es" ? "Fintech / Aplicaci√≥n Web" : "Fintech / Web Application",
    description: lang === "es" ? "Interfaz elegante para servicios financieros" : "Elegant interface for financial services",
    asset: "/images/hero-websites/fintech-website-video-compressed.webm",
    type: "video",
    bgGradient: "from-indigo-600 to-blue-700",
    icon: "üí∞"
  },
  {
    id: 6,
    title: lang === "es" ? "E-commerce Premium" : "Premium E-commerce",
    category: lang === "es" ? "Tienda Online / E-commerce" : "Online Store / E-commerce",
    description: lang === "es" ? "Tienda online optimizada para conversiones" : "Online store optimized for conversions",
    asset: "/images/hero-websites/marketing-website.webp",
    type: "image",
    bgGradient: "from-purple-600 to-pink-700",
    icon: "üõçÔ∏è"
  },
  {
    id: 7,
    title: lang === "es" ? "Restaurante Moderno" : "Modern Restaurant",
    category: lang === "es" ? "Restauraci√≥n / Hosteler√≠a" : "Restaurant / Hospitality",
    description: lang === "es" ? "Web gastron√≥mica con reservas online" : "Gastronomic website with online reservations",
    asset: "/images/hero-websites/restaurant-landing.webp",
    type: "image",
    bgGradient: "from-amber-600 to-orange-700",
    icon: "üçΩÔ∏è"
  }
];
---

<div class="relative w-full h-full overflow-hidden rounded-lg bg-slate-900">
  <!-- Carousel Container -->
  <div id="website-carousel" class="flex transition-transform duration-300 ease-out h-full">
    {websiteExamples.map((site, index) => (
      <div 
        class="min-w-full h-full relative flex items-center justify-center bg-gradient-to-br {site.bgGradient} opacity-95"
        data-slide={index}
      >
        <!-- Website Showcase -->
        <div class="relative w-full max-w-6xl mx-auto px-4">
          <!-- Modern Container -->
          <div class="relative bg-white/5 backdrop-blur-sm rounded-2xl overflow-hidden shadow-2xl border border-white/10">
            <!-- Top Bar -->
            <div class="bg-gradient-to-r from-black/40 to-black/30 backdrop-blur-md p-4 flex items-center justify-between border-b border-white/10">
              <div class="flex items-center space-x-3">
                <div class="flex space-x-2">
                  <div class="w-3 h-3 bg-red-400 rounded-full shadow-sm"></div>
                  <div class="w-3 h-3 bg-yellow-400 rounded-full shadow-sm"></div>
                  <div class="w-3 h-3 bg-green-400 rounded-full shadow-sm"></div>
                </div>
                <div class="bg-black/50 backdrop-blur-sm rounded-lg px-3 py-1.5 text-xs text-white font-medium border border-white/20 shadow-lg">
                  {site.title.toLowerCase().replace(/\s+/g, '')}.com
                </div>
              </div>
              <!-- Category Badge -->
              <div class="bg-black/60 backdrop-blur-md text-white px-4 py-1.5 rounded-full text-xs font-bold border border-white/30 shadow-lg">
                <span class="text-sm mr-1">{site.icon}</span>
                {site.category}
              </div>
            </div>
            
            <!-- Website Content Container -->
            <div class="relative overflow-hidden" style="min-height: 450px;">
              {site.type === 'video' ? (
                <video 
                  class="carousel-video w-full h-full object-cover object-top"
                  autoplay 
                  muted 
                  loop 
                  playsinline
                  preload="metadata"
                  style="min-height: 450px;"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                  data-webm-src={site.asset}
                >
                  <source src={`${site.asset}?${CACHE_VERSION}`} type="video/webm" />
                  <div class="w-full h-full bg-slate-200 flex items-center justify-center" style="display: none;">
                    <div class="text-center">
                      <div class="text-4xl mb-4">üé¨</div>
                      <span class="text-slate-500 text-sm">{lang === "es" ? "Video no disponible" : "Video not available"}</span>
                    </div>
                  </div>
                </video>
              ) : (
                <img 
                  src={site.asset} 
                  alt={`${lang === "es" ? "Dise√±o web ejemplo para" : "Website design example for"} ${site.title}`}
                  class="w-full h-full object-cover object-top"
                  style="min-height: 450px;"
                  loading="lazy"
                />
              )}
            </div>
          </div>
        </div>
        
      </div>
    ))}
  </div>

  <!-- Navigation Arrows -->
  <button 
    class="carousel-prev absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white border border-white/20 hover:border-white/40 transition-all duration-200 group z-10"
    aria-label={lang === "es" ? "Anterior" : "Previous"}
  >
    <svg class="w-5 h-5 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
    </svg>
  </button>

  <button 
    class="carousel-next absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white border border-white/20 hover:border-white/40 transition-all duration-200 group z-10"
    aria-label={lang === "es" ? "Siguiente" : "Next"}
  >
    <svg class="w-5 h-5 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
  </button>
  
  <!-- Navigation Dots -->
  <div class="absolute bottom-8 right-8 flex space-x-2">
    {websiteExamples.map((_, index) => (
      <button 
        class="w-2 h-2 rounded-full bg-white/30 hover:bg-white/70 transition-all duration-200 carousel-dot hover:scale-125"
        data-slide={index}
        aria-label={`${lang === "es" ? "Ir al slide" : "Go to slide"} ${index + 1}`}
      ></button>
    ))}
  </div>
  
  <!-- Progress Bar -->
  <div class="absolute bottom-0 left-0 w-full h-1 bg-black/20">
    <div id="carousel-progress" class="h-full bg-gradient-to-r from-blue-400 to-purple-500 w-0"></div>
  </div>
</div>

<script>
  class WebsiteCarousel {
    carousel: HTMLElement | null;
    dots: NodeListOf<Element>;
    progress: HTMLElement | null;
    currentSlide: number;
    totalSlides: number;
    isPlaying: boolean;
    intervalId: number | null;
    slideInterval: number;

    constructor() {
      this.carousel = document.getElementById('website-carousel');
      this.dots = document.querySelectorAll('.carousel-dot');
      this.progress = document.getElementById('carousel-progress');
      this.currentSlide = 0;
      this.totalSlides = this.dots.length;
      this.isPlaying = true;
      this.intervalId = null;
      this.slideInterval = 5000; // 5 seconds per slide for better viewing of real content
      
      this.init();
    }
    
    init() {
      // Set up dot click listeners
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', () => this.goToSlide(index));
      });
      
      // Set up arrow click listeners
      const prevBtn = document.querySelector('.carousel-prev');
      const nextBtn = document.querySelector('.carousel-next');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => this.prevSlide());
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => this.nextSlide());
      }
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') this.prevSlide();
        if (e.key === 'ArrowRight') this.nextSlide();
      });
      
      // Start auto-play
      this.startAutoPlay();
      
      // Pause on hover
      this.carousel.parentElement.addEventListener('mouseenter', () => this.pauseAutoPlay());
      this.carousel.parentElement.addEventListener('mouseleave', () => this.startAutoPlay());
      
      // Initial state
      this.updateDots();
      this.updateProgress();
      
      // Ensure video sources are correct
      this.fixVideoSources();
    }
    
    goToSlide(index: number) {
      this.currentSlide = index;
      const translateX = -index * 100;
      if (this.carousel) {
        this.carousel.style.transform = `translateX(${translateX}%)`;
      }
      this.updateDots();
      this.resetProgress();
    }
    
    nextSlide() {
      this.currentSlide = (this.currentSlide + 1) % this.totalSlides;
      this.goToSlide(this.currentSlide);
    }
    
    prevSlide() {
      this.currentSlide = (this.currentSlide - 1 + this.totalSlides) % this.totalSlides;
      this.goToSlide(this.currentSlide);
    }
    
    updateDots() {
      this.dots.forEach((dot, index) => {
        if (index === this.currentSlide) {
          dot.classList.add('bg-white', 'scale-150');
          dot.classList.remove('bg-white/30');
        } else {
          dot.classList.add('bg-white/30');
          dot.classList.remove('bg-white', 'scale-150');
        }
      });
    }
    
    updateProgress() {
      let startTime = Date.now();
      let lastUpdate = 0;
      const updateInterval = 100; // Update every 100ms instead of every frame
      
      const animate = () => {
        if (!this.isPlaying) return;
        
        const now = Date.now();
        if (now - lastUpdate >= updateInterval) {
          const elapsed = now - startTime;
          const progress = Math.min((elapsed / this.slideInterval) * 100, 100);
          if (this.progress) {
            this.progress.style.width = `${progress}%`;
          }
          lastUpdate = now;
        }
        
        if (now - startTime < this.slideInterval) {
          requestAnimationFrame(animate);
        }
      };
      
      requestAnimationFrame(animate);
    }
    
    resetProgress() {
      if (this.progress) {
        this.progress.style.width = '0%';
      }
      this.updateProgress();
    }
    
    startAutoPlay() {
      if (this.intervalId) clearInterval(this.intervalId);
      this.isPlaying = true;
      this.intervalId = setInterval(() => {
        this.nextSlide();
      }, this.slideInterval);
      this.updateProgress();
    }
    
    pauseAutoPlay() {
      this.isPlaying = false;
      if (this.intervalId) {
        clearInterval(this.intervalId);
        this.intervalId = null;
      }
    }
    
    fixVideoSources() {
      // Ensure all video sources are using .webm and not .mp4
      const CACHE_VERSION = "v20250816-2";
      const videos = document.querySelectorAll('.carousel-video');
      videos.forEach((video: HTMLVideoElement) => {
        const webmSrc = video.getAttribute('data-webm-src');
        if (webmSrc) {
          const source = video.querySelector('source');
          if (source) {
            // Force the source to use .webm extension with cache busting
            source.src = `${webmSrc}?${CACHE_VERSION}`;
            source.type = 'video/webm';
            video.load(); // Reload the video element
          }
        }
      });
    }
  }
  
  // Initialize carousel when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new WebsiteCarousel();
  });
  
  // Reinitialize on navigation (for SPA behavior)
  document.addEventListener('astro:page-load', () => {
    new WebsiteCarousel();
  });
</script>

<style>
  /* Ensure smooth transitions */
  #website-carousel {
    will-change: transform;
    transform: translateZ(0); /* Hardware acceleration */
    backface-visibility: hidden;
  }
  
  /* Navigation arrows */
  .carousel-prev, .carousel-next {
    backdrop-filter: blur(6px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .carousel-prev:hover, .carousel-next:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  }
  
  /* Hover effects for dots */
  .carousel-dot {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  .carousel-dot:hover {
    transform: scale(1.3);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
  }
  
  /* Progress bar animation */
  #carousel-progress {
    will-change: width;
    background: linear-gradient(90deg, rgba(59, 130, 246, 0.8), rgba(147, 51, 234, 0.8));
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
  }
  
  /* Video and image optimization */
  video, img {
    transition: opacity 0.2s ease;
  }
  
  
  /* Modern container styling */
  .bg-white\/5 {
    backdrop-filter: blur(8px);
    box-shadow: 0 15px 25px rgba(0, 0, 0, 0.1);
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .carousel-dot {
      width: 6px;
      height: 6px;
    }
    
    .carousel-prev, .carousel-next {
      width: 40px;
      height: 40px;
    }
    
    .carousel-prev {
      left: 2rem;
    }
    
    .carousel-next {
      right: 2rem;
    }
    
    .absolute.bottom-8.right-8 {
      bottom: 1rem;
      right: 1rem;
    }
  }
  
  @media (max-width: 480px) {
    .carousel-prev {
      left: 1rem;
    }
    
    .carousel-next {
      right: 1rem;
    }
  }
  
  /* Ensure videos play smoothly */
  video {
    background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
    transform: translateZ(0); /* Hardware acceleration for videos */
  }
  
  /* Optimize slide containers */
  .min-w-full {
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  
  /* Smooth hover effects for the entire container */
  .min-w-full:hover .bg-white\/5 {
    border-color: rgba(255, 255, 255, 0.2);
  }
  
  /* Enhanced focus states for accessibility */
  .carousel-prev:focus,
  .carousel-next:focus,
  .carousel-dot:focus {
    outline: 2px solid rgba(59, 130, 246, 0.5);
    outline-offset: 2px;
  }
</style>