---
import { getLocaleFromPath, getTranslation } from '../i18n/utils';
import Translate from './Translate.astro';

const locale = getLocaleFromPath(Astro.url.pathname);
const t = (key: string) => getTranslation(locale, key);
---
<section class="py-12 sm:py-16 md:py-20" id="contacto">
  <div class="container">
    <div class="text-center mb-12 sm:mb-16 px-4">
      <h2 class="text-2xl sm:text-3xl font-bold mb-3 sm:mb-4"><Translate key="contact.title" /></h2>
      <p class="text-text-muted text-sm sm:text-base"><Translate key="contact.subtitle" /></p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 sm:gap-10 md:gap-12 px-4 sm:px-0">
      <div>
        <h3 class="text-lg sm:text-xl font-bold mb-4"><Translate key="contact.directContact" /></h3>
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-accent flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <a href="mailto:contact@ignacioamatweb.com" class="hover:text-accent transition-colors text-sm sm:text-base break-all">
              ignacioamat@ignathedev.com
            </a>
          </div>
          <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-accent flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span class="text-sm sm:text-base"><Translate key="contact.location" /></span>
          </div>
        </div>

        <div class="mt-6 sm:mt-8">
          <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4"><Translate key="contact.response" /></h3>
          <p class="text-text-muted text-sm sm:text-base"><Translate key="contact.responseTime" /></p>
        </div>
      </div>

      <div>
        <form
          id="contact-form"
          class="space-y-4 sm:space-y-6"
          method="POST"
        >
          <div>
            <label for="name" class="block mb-2 text-sm sm:text-base"><Translate key="contact.name" /></label>
            <input
              type="text"
              id="name"
              name="name"
              required
              placeholder={t('contact.placeholders.name')}
              class="w-full px-4 py-2.5 sm:py-2 text-sm sm:text-base bg-secondary border border-border rounded-lg focus:outline-none focus:border-accent"
            />
          </div>

          <div>
            <label for="email" class="block mb-2 text-sm sm:text-base">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder={t('contact.placeholders.email')}
              class="w-full px-4 py-2.5 sm:py-2 text-sm sm:text-base bg-secondary border border-border rounded-lg focus:outline-none focus:border-accent"
            />
          </div>

          <div>
            <label for="type" class="block mb-2 text-sm sm:text-base"><Translate key="contact.projectType" /></label>
            <select
              id="type"
              name="type"
              required
              class="w-full px-4 py-2.5 sm:py-2 text-sm sm:text-base bg-secondary border border-border rounded-lg focus:outline-none focus:border-accent"
            >
              <option value="">{t('contact.selectOption')}</option>
              <option value="landing">{t('contact.options.landing')}</option>
              <option value="web">{t('contact.options.complete')}</option>
              <option value="ecommerce">{t('contact.options.ecommerce')}</option>
              <option value="other">{t('contact.options.other')}</option>
            </select>
          </div>

          <div>
            <label for="message" class="block mb-2 text-sm sm:text-base"><Translate key="contact.message" /></label>
            <textarea
              id="message"
              name="message"
              rows="5"
              required
              placeholder={t('contact.placeholders.message')}
              class="w-full px-4 py-2.5 sm:py-2 text-sm sm:text-base bg-secondary border border-border rounded-lg focus:outline-none focus:border-accent resize-none"
            ></textarea>
          </div>

          <button type="submit" class="btn-primary w-full text-sm sm:text-base">
            <Translate key="contact.send" />
          </button>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
  input, select, textarea {
    color: var(--color-text);
  }

  input::placeholder, textarea::placeholder {
    color: var(--color-text-muted);
  }

  .text-accent {
    color: var(--color-accent);
  }

  .bg-secondary {
    background-color: var(--color-secondary);
  }

  .border-border {
    border-color: var(--color-border);
  }

  .text-text-muted {
    color: var(--color-text-muted);
  }

  h2, h3 {
    font-weight: 800;
  }

  /* Custom toast styles */
  :global(.custom-toast) {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 8px;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s, transform 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: 320px;
  }

  :global(.toast-success) {
    background-color: #10b981;
  }

  :global(.toast-error) {
    background-color: #ef4444;
  }

  :global(.toast-visible) {
    opacity: 1;
    transform: translateY(0);
  }

  :global(.toast-icon) {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
  }

  :global(.toast-content) {
    flex-grow: 1;
  }

  :global(.toast-title) {
    font-weight: 600;
    margin-bottom: 4px;
  }

  :global(.toast-message) {
    font-size: 14px;
    opacity: 0.9;
  }

  /* Responsive toast adjustments */
  @media (max-width: 640px) {
    :global(.custom-toast) {
      bottom: 10px;
      right: 10px;
      left: 10px;
      max-width: none;
    }
  }
</style>

<script is:inline define:vars={{ locale }}>
  // Custom toast implementation to ensure it works reliably
  function showToast(type, title, message, duration = 5000) {
    // Remove any existing toast
    const existingToast = document.querySelector('.custom-toast');
    if (existingToast) {
      existingToast.remove();
    }

    // Create toast container
    const toast = document.createElement('div');
    toast.className = `custom-toast toast-${type}`;

    // Create icon based on type
    const icon = document.createElement('div');
    icon.className = 'toast-icon';

    if (type === 'success') {
      icon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z"/>
        </svg>
      `;
    } else {
      icon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"/>
        </svg>
      `;
    }

    // Create content container
    const content = document.createElement('div');
    content.className = 'toast-content';

    // Add title if provided
    if (title) {
      const titleEl = document.createElement('div');
      titleEl.className = 'toast-title';
      titleEl.textContent = title;
      content.appendChild(titleEl);
    }

    // Add message
    const messageEl = document.createElement('div');
    messageEl.className = 'toast-message';
    messageEl.textContent = message;
    content.appendChild(messageEl);

    // Build the toast
    toast.appendChild(icon);
    toast.appendChild(content);

    // Add to document
    document.body.appendChild(toast);

    // Show the toast (trigger animation)
    setTimeout(() => {
      toast.classList.add('toast-visible');
    }, 10);

    // Auto-remove after duration
    setTimeout(() => {
      toast.classList.remove('toast-visible');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, duration);
  }

  // Translation helper
  const translations = {
    es: {
      sending: 'Enviando...',
      send: 'Enviar mensaje',
      error: 'Error',
      success: 'Éxito',
      requiredFields: 'Por favor, rellena todos los campos requeridos.',
      successMessage: 'Mensaje enviado correctamente. Me pondré en contacto contigo pronto.',
      errorMessage: 'Error al enviar el mensaje. Por favor, inténtalo de nuevo más tarde.'
    },
    en: {
      sending: 'Sending...',
      send: 'Send message',
      error: 'Error',
      success: 'Success',
      requiredFields: 'Please fill in all required fields.',
      successMessage: 'Message sent successfully. I will get in touch with you soon.',
      errorMessage: 'Error sending the message. Please try again later.'
    }
  };

  const t = (key) => translations[locale][key] || key;

  // Global function to handle form submission
  async function handleSubmit(event) {
    event.preventDefault();

    const form = document.getElementById('contact-form');
    const submitButton = form.querySelector('button[type="submit"]');

    if (!form || !submitButton) {
      console.error('Form or submit button not found');
      return;
    }

    submitButton.disabled = true;
    submitButton.textContent = t('sending');

    try {
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => {
        data[key] = value;
      });

      // Add locale to form data
      data.locale = locale;


      // Validate required fields
      if (!data.name || !data.email || !data.message) {
        showToast('error', t('error'), t('requiredFields'));
        submitButton.disabled = false;
        submitButton.textContent = t('send');
        return;
      }

      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        showToast('success', t('success'), result.message || t('successMessage'));
        form.reset();
      } else {
        throw new Error(result.error || t('errorMessage'));
      }
    } catch (error) {
      console.error('Form submission error:', error);
      showToast('error', t('error'), error.message || t('errorMessage'));
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = t('send');
    }
  }

  // Attach event listener when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initForm);
  } else {
    initForm();
  }

  function initForm() {
    const form = document.getElementById('contact-form');
    if (form) {
      form.addEventListener('submit', handleSubmit);
    }
  }
</script>
