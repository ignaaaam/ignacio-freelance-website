---
import '../styles/global.css';
import { getAlternateUrls } from '../i18n/utils';
import PlunkToaster from '../components/Toaster.tsx';
import { ViewTransitions } from 'astro:transitions';

interface Props {
	title: string;
	description?: string;
	lang?: 'es' | 'en';
	canonicalUrl?: string;
	image?: string;
	author?: string;
	type?: 'website' | 'article';
	publishedDate?: string;
	keywords?: string[];
	additionalSchemas?: any[];
	alternateUrls?: { es: string; en: string };
}

const { 
	title,
	lang = 'es', 
	description = lang === 'es' 
		? "Diseño y desarrollo webs modernas, rápidas y optimizadas para destacar a nivel global."
		: "Modern, fast, and optimized web design and development for global impact.",
	canonicalUrl,
	image = "https://ignacioamatweb.com/images/og-image.png",
	author = "Ignacio Amat",
	type = "website",
	publishedDate,
	keywords = lang === 'es'
		? ["crear página web para mi empresa", "desarrollador web Barcelona", "crear página web Barcelona", "diseño web Barcelona", "desarrollo web freelance", "página web para negocio", "crear sitio web empresa", "desarrollador web España", "diseño web profesional", "SEO Barcelona", "página web optimizada", "desarrollo web personalizado", "Ignacio Amat"]
		: ["create website for my business", "web developer Barcelona", "create website Barcelona", "web design Barcelona", "freelance web development", "website for business", "create business website", "web developer Spain", "professional web design", "SEO Barcelona", "optimized website", "custom web development", "Ignacio Amat"],
	additionalSchemas = [],
	alternateUrls: customAlternateUrls
} = Astro.props;

const currentPath = Astro.url.pathname;
const alternateUrls = customAlternateUrls || getAlternateUrls(currentPath);
const baseUrl = 'https://ignacioamatweb.com';
const fullUrl = `${baseUrl}${currentPath}`;
const canonical = canonicalUrl ? `${baseUrl}${canonicalUrl}` : fullUrl;

// Build structured data for different page types
const structuredData: any = {
	"@context": "https://schema.org",
	"@type": type === 'website' ? 'WebSite' : 'Article',
	"url": fullUrl,
	"name": title,
	"description": description,
	"author": {
		"@type": "Person",
		"name": author,
		"url": baseUrl
	},
	"inLanguage": lang,
	"image": image
};

// Add publishedDate for articles
if (type === 'article' && publishedDate) {
	structuredData.datePublished = publishedDate;
	structuredData.dateModified = new Date().toISOString().split('T')[0];
}

// Organization structured data
const organizationSchema = {
	"@context": "https://schema.org",
	"@type": "Organization",
	"name": "Ignacio Amat",
	"url": baseUrl,
	"logo": `${baseUrl}/images/og-image.png`,
	"sameAs": [
		"https://www.linkedin.com/in/ignacio-amat-urbina-789244223/",
		"https://github.com/ignaaaam",
		"https://x.com/ignathedev"
	],
	"contactPoint": {
		"@type": "ContactPoint",
		"contactType": "Customer Service",
		"availableLanguage": ["Spanish", "English"]
	}
};

// Breadcrumb schema for non-home pages
const breadcrumbSchema = currentPath !== '/' && currentPath !== '/en/' ? {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"name": "Home",
			"item": baseUrl
		},
		{
			"@type": "ListItem",
			"position": 2,
			"name": title,
			"item": fullUrl
		}
	]
} : null;

// JSON-LD structured data
const jsonLd = JSON.stringify(structuredData);
const orgJsonLd = JSON.stringify(organizationSchema);
const breadcrumbJsonLd = breadcrumbSchema ? JSON.stringify(breadcrumbSchema) : null;
---

<!DOCTYPE html>
<html lang={lang} data-theme="dark">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- Primary Meta Tags -->
		<title>{title}</title>
		<meta name="title" content={title} />
		<meta name="description" content={description} />
		<meta name="author" content={author} />
		<meta name="keywords" content={keywords.join(', ')} />
		<link rel="canonical" href={canonical} />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content={type} />
		<meta property="og:url" content={fullUrl} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={image} />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:image:alt" content={title} />
		<meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
		<meta property="og:locale:alternate" content={lang === 'es' ? 'en_US' : 'es_ES'} />
		<meta property="og:site_name" content="Ignacio Amat - Freelance Web Developer" />
		{publishedDate && <meta property="article:published_time" content={publishedDate} />}
		{type === 'article' && <meta property="article:author" content={author} />}

		<!-- Twitter Card data -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@ignathedev" />
		<meta name="twitter:creator" content="@ignathedev" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={image} />
		<meta name="twitter:image:alt" content={title} />
		<meta name="twitter:domain" content="ignacioamatweb.com" />

		<!-- Additional SEO Meta Tags -->
		<meta name="rating" content="general" />
		<meta name="distribution" content="global" />
		<meta name="coverage" content="Worldwide" />
		<meta name="target" content="all" />
		<meta name="HandheldFriendly" content="True" />
		<meta name="MobileOptimized" content="320" />

		<!-- Language and SEO meta tags -->
		<link rel="alternate" hreflang="es" href={`${baseUrl}${alternateUrls.es}`} />
		<link rel="alternate" hreflang="en" href={`${baseUrl}${alternateUrls.en}`} />
		<link rel="alternate" hreflang="x-default" href={`${baseUrl}${alternateUrls.es}`} />
		<meta http-equiv="content-language" content={lang} />
		
		<!-- Robots meta tag -->
		<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />

		<!-- Google Search Console Verification - Add your verification code -->
		<!-- <meta name="google-site-verification" content="YOUR_VERIFICATION_CODE" /> -->

		<!-- Mobile specific -->
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="format-detection" content="telephone=no" />

		<!-- Theme color -->
		<meta name="theme-color" content="#0F172A" />
		
		<!-- Preconnect to required origins -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

		<!-- Preload LCP image -->
		<link rel="preload" as="image" href="/images/hero-website.png" fetchpriority="high" />

		<!-- DNS Prefetch for external resources -->
		<link rel="dns-prefetch" href="https://www.googletagmanager.com" />
		<link rel="dns-prefetch" href="https://www.google-analytics.com" />

		<!-- Preload critical fonts -->
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700;800&display=swap" />
		<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" />

		<!-- Load fonts asynchronously -->
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700;800&display=swap" media="print" onload="this.media='all'" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'" />

		<!-- Fallback for no-JS -->
		<noscript>
			<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700;800&display=swap" />
			<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" />
		</noscript>

		<!-- Structured Data -->
		<script type="application/ld+json" set:html={jsonLd} />
		<script type="application/ld+json" set:html={orgJsonLd} />
		{breadcrumbJsonLd && <script type="application/ld+json" set:html={breadcrumbJsonLd} />}
		{additionalSchemas.map(schema => (
			<script type="application/ld+json" set:html={JSON.stringify(schema)} />
		))}

		<!-- Google Analytics 4 -->
		<script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-3ZDBF6HWZX"></script>
		<script is:inline>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'G-3ZDBF6HWZX', {
				page_path: window.location.pathname,
				anonymize_ip: true,
				send_page_view: true,
				cookie_flags: 'SameSite=None;Secure'
			});

			// Track scroll depth
			let scrollDepth = 0;
			window.addEventListener('scroll', function() {
				const scrollPercentage = Math.round((window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100);
				if (scrollPercentage > scrollDepth && scrollPercentage % 25 === 0) {
					scrollDepth = scrollPercentage;
					gtag('event', 'scroll_depth', {
						'event_category': 'engagement',
						'event_label': scrollPercentage + '%',
						'value': scrollPercentage
					});
				}
			});

			// Track outbound links
			document.addEventListener('click', function(e) {
				const link = e.target.closest('a');
				if (link && link.hostname !== window.location.hostname) {
					gtag('event', 'click', {
						'event_category': 'outbound',
						'event_label': link.href,
						'transport_type': 'beacon'
					});
				}
			});
		</script>

		<ViewTransitions />
	</head>
	<body>
		<slot />
		<PlunkToaster client:idle />
	</body>
</html>

<style>
	/* Theme transitions */
	:root {
		transition: all 0.3s ease;
	}

	/* Light theme overrides */
	[data-theme="light"] {
		--color-primary: #ffffff;
		--color-secondary: #f1f5f9;
		--color-text: #0f172a;
		--color-text-muted: #64748b;
		--color-border: #e2e8f0;
		--color-card-bg: rgba(241, 245, 249, 0.5);
	}


	/* Glow effects */
	.glow {
		position: absolute;
		border-radius: 50%;
		filter: blur(100px);
		opacity: 0.15;
		pointer-events: none;
	}

	.glow-1 {
		top: 0;
		left: 15%;
		width: 300px;
		height: 300px;
		background: var(--color-accent);
	}

	.glow-2 {
		top: 20%;
		right: 10%;
		width: 400px;
		height: 400px;
		background: #3b82f6;
	}

	/* Reduce glow effects on mobile */
	@media (max-width: 768px) {
		.glow {
			opacity: 0.08;
			filter: blur(60px);
		}

		.glow-1 {
			width: 200px;
			height: 200px;
			left: 10%;
		}

		.glow-2 {
			width: 250px;
			height: 250px;
			right: 5%;
		}
	}

	[data-theme="light"] .glow {
		opacity: 0.1;
	}
</style>

<script>
	// Theme toggle functionality
	const themeToggle = document.getElementById('theme-toggle');
	const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
	
	function setTheme(isDark: boolean) {
		document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
		localStorage.setItem('theme', isDark ? 'dark' : 'light');
	}

	// Initialize theme
	const savedTheme = localStorage.getItem('theme');
	if (savedTheme) {
		setTheme(savedTheme === 'dark');
	} else {
		setTheme(prefersDark.matches);
	}

	// Listen for theme toggle clicks
	themeToggle?.addEventListener('click', () => {
		const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
		setTheme(!isDark);
	});

	// Listen for system theme changes
	prefersDark.addEventListener('change', (e) => {
		if (!localStorage.getItem('theme')) {
			setTheme(e.matches);
		}
	});

	// Intersection Observer for scroll animations
	document.addEventListener('DOMContentLoaded', () => {
		const observerOptions = {
			threshold: 0.1,
			rootMargin: '0px 0px -50px 0px'
		};

		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					entry.target.classList.add('visible');
					observer.unobserve(entry.target); // Animate only once - no CLS
				}
			});
		}, observerOptions);

		document.querySelectorAll('[data-sr]').forEach(el => observer.observe(el));
	});
</script>
